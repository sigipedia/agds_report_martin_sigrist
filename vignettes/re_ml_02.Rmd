---
title: "Supervised Machine Learning II"
author: "Maritn Sigrist"
date: "2023-05-15"
output: html_document
toc: true
---

# Load required Libraries
```{r}
library(tidyverse)
library(caret)
library(recipes)
```

# Load external functions
```{r}
source("../R/eval_model.R")
source("../R/read_data.R")
```


## Read and Clean Data
```{r}
# Data for Davos site
daily_fluxes_dav <- read_data("../data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv")
# Data for Laegern site
daily_fluxes_lae <- read_data("../data/FLX_CH-Lae_FLUXNET2015_FULLSET_DD_2004-2014_1-4.csv")
```

## Data spliting 
```{r}
# set random generator seed for reproducibility
set.seed(1982)

# Split data for Davos site (80% for training and 20% for testing)
split <- rsample::initial_split(daily_fluxes_dav, prop = 0.8, strata = "VPD_F")
daily_fluxes_dav_train <- rsample::training(split)
daily_fluxes_dav_test <- rsample::testing(split)

# Split data for Laegern site  (80% for training and 20% for testing)
split <- rsample::initial_split(daily_fluxes_lae, prop = 0.8, strata = "VPD_F")
daily_fluxes_lae_train <- rsample::training(split)
daily_fluxes_lae_test <- rsample::testing(split)
```


# Model for Davos site
## Model and pre-processing formulation
```{r}
# Use all variables but LW_IN_F
pp_dav <- recipes::recipe(GPP_NT_VUT_REF ~ SW_IN_F + VPD_F + TA_F + VPD_F + PA_F + P_F + WS_F,
                      data = daily_fluxes_dav_train |> drop_na()) |>
  recipes::step_BoxCox(all_predictors()) |>
  recipes::step_center(all_numeric(), -all_outcomes()) |>
  recipes::step_scale(all_numeric(), -all_outcomes())
```

## Hyper parameter tuning
```{r}
# Tune hyperparameter k with cross validation and Mean Absolut Error as metric
suppressWarnings( # Suppress warnings from Box-Cox-Transformation
  mod_knn_dav <- caret::train(
    pp_dav, 
    data = daily_fluxes_dav_train |> drop_na(), 
    method = "knn",
    trControl = caret::trainControl(method = "cv",
                                    number = 5,
                                    search = "grid"),
    tuneGrid = expand.grid(k = c(1, 2, 5, 10, 15, 18, 19, 20, 21, 22, 23, 24, 25, 50, 100, 200)),
    metric = "MAE"
  )
)

# Create plot
ggplot(
    data = mod_knn_dav$results,
    aes(x = k, y = MAE)) +
  geom_line(size = 1) +
  geom_point(
    data = mod_knn_dav$results |> filter(k == mod_knn_dav$bestTune[1,1]) |> select(k, MAE),
    aes(x = k, y = MAE), size = 3, color = "tomato") +
  geom_text(x=25, y=1.2, label = paste("k = ", mod_knn_dav$bestTune[1,1])) +
  labs(title = "MAE vs. k by Cross Validation", 
       x = "k", 
       y = "MAE") +
  theme_classic()

```

## Comparision within- and across-site
```{r}
eval_model(mod = mod_knn_dav, df_train = daily_fluxes_dav_test, df_test = daily_fluxes_lae_test, title_train="Within-Site", title_test="Across-Site")
```


# Model for Laegern site
## Model and pre-processing formulation
```{r}
# Use all variables but LW_IN_F
pp_lae <- recipes::recipe(GPP_NT_VUT_REF ~ SW_IN_F + VPD_F + TA_F + VPD_F + PA_F + P_F + WS_F,
                      data = daily_fluxes_lae_train |> drop_na()) |>
  recipes::step_BoxCox(all_predictors()) |>
  recipes::step_center(all_numeric(), -all_outcomes()) |>
  recipes::step_scale(all_numeric(), -all_outcomes())
```

## Hyper parameter tuning
```{r}
# Tune hyperparameter k with cross validation and Mean Absolut Error as metric
suppressWarnings( # Suppress warnings from Box-Cox-Transformation
  mod_knn_lae <- caret::train(
    pp_lae,
    data = daily_fluxes_lae_train |> drop_na(),
    method = "knn",
    trControl = caret::trainControl(method = "cv",
                                    number = 5,
                                    search = "grid"),
    tuneGrid = expand.grid(k = c(1, 2, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 20, 25, 30, 50, 100, 200)),
    metric = "MAE"
  )
)

# Create plot
ggplot(
    data = mod_knn_lae$results,
    aes(x = k, y = MAE)) +
  geom_line(size = 1) +
  geom_point(
    data = mod_knn_lae$results |> filter(k == mod_knn_lae$bestTune[1,1]) |> select(k, MAE),
    aes(x = k, y = MAE), size = 3, color = "tomato") +
  geom_text(x=25, y=2.1, label = paste("k = ", mod_knn_lae$bestTune[1,1])) +
  labs(title = "MAE vs. k by Cross Validation", 
       x = "k", 
       y = "MAE") +
  theme_classic()

```

## Comparision within- and across-site
```{r}
eval_model(mod = mod_knn_lae, df_train = daily_fluxes_lae_test, df_test = daily_fluxes_dav_test, title_train="Within-Site", title_test="Across-Site")
```

# Model trained with combined data
## Combined data from both sites
```{r}
daily_fluxes_comb_train <- bind_rows(daily_fluxes_dav_train, daily_fluxes_lae_train)
```

## Model and pre-processing formulation
```{r}
# Use all variables but LW_IN_F
pp_comb <- recipes::recipe(GPP_NT_VUT_REF ~ SW_IN_F + VPD_F + TA_F + VPD_F + PA_F + P_F + WS_F,
                      data = daily_fluxes_comb_train |> drop_na()) |>
  recipes::step_BoxCox(all_predictors()) |>
  recipes::step_center(all_numeric(), -all_outcomes()) |>
  recipes::step_scale(all_numeric(), -all_outcomes())
```

## Hyper parameter tuning
```{r}
# Tune hyperparameter k with cross validation and Mean Absolut Error as metric
suppressWarnings( # Suppress warnings from Box-Cox-Transformation
  mod_knn_comb <- caret::train(
    pp_comb,
    data = daily_fluxes_comb_train |> drop_na(),
    method = "knn",
    trControl = caret::trainControl(method = "cv",
                                    number = 5,
                                    search = "grid"),
    tuneGrid = expand.grid(k = c(1, 5, 7, 9, 11, 13, 14, 15, 16, 17, 18, 20, 25, 30, 50, 100, 200)),
    metric = "MAE"
  )
)

# Create plot
ggplot(
    data = mod_knn_comb$results,
    aes(x = k, y = MAE)) +
  geom_line(size = 1) +
  geom_point(
    data = mod_knn_comb$results |> filter(k == mod_knn_comb$bestTune[1,1]) |> select(k, MAE),
    aes(x = k, y = MAE), size = 3, color = "tomato") +
  geom_text(x=25, y=1.65, label = paste("k = ", mod_knn_comb$bestTune[1,1])) +
  labs(title = "MAE vs. k by Cross Validation", 
       x = "k", 
       y = "MAE") +
  theme_classic()

```

## Prediction for both sites with combined model
```{r}
eval_model(mod = mod_knn_comb, df_train = daily_fluxes_dav_test, df_test = daily_fluxes_lae_test, title_train="Davos", title_test="Laegern")
```



